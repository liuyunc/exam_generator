<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>JSON分片考试题生成器（DeepSeek + GA对）</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffffcc;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --brand: #0a84ff;
      --brand-strong: #0060df;
      --accent: #34c759;
      --shadow: 0 20px 45px -25px rgba(0, 0, 0, 0.25);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 32px 0 48px;
      font-family: "SF Pro Display", "SF Pro Text", -apple-system, BlinkMacSystemFont,
        "Segoe UI", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 20% 20%, #f7fbff, #edf2f7 35%),
        radial-gradient(circle at 80% 0%, #f4f8ff, #e7ecf5 45%),
        linear-gradient(135deg, #f8fbff 0%, #eef2f7 50%, #f7f9fb 100%);
    }

    .app-shell {
      width: min(1160px, 94vw);
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .logo-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0a84ff, #34c759);
      box-shadow: 0 8px 18px rgba(10, 132, 255, 0.25);
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.2px;
    }

    .subhead {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      margin-bottom: 16px;
    }

    h2 {
      margin: 0 0 14px;
      font-size: 18px;
      letter-spacing: 0.2px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 18px;
    }

    .full-row {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.1px;
    }

    input[type="text"], input[type="number"], textarea, input[type="file"] {
      width: 100%;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fdfdff;
      transition: border 0.18s ease, box-shadow 0.18s ease;
    }

    textarea { min-height: 140px; resize: vertical; }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.12);
    }

    .hint {
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
    }

    .button-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .error-banner {
      display: none;
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #ffebe9;
      background: linear-gradient(135deg, #fff5f5, #ffecec);
      color: #b00020;
      box-shadow: 0 10px 30px rgba(255, 107, 114, 0.12);
      font-size: 13px;
      line-height: 1.5;
    }

    .error-line + .error-line { margin-top: 6px; }

    button {
      border: none;
      border-radius: 12px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.18s ease, background 0.2s ease;
    }

    .primary {
      background: linear-gradient(145deg, var(--brand), #2992ff);
      color: white;
      box-shadow: 0 12px 25px rgba(10, 132, 255, 0.28);
    }

    .primary:hover { transform: translateY(-1px); }

    .ghost {
      background: #f5f7fb;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .ghost:disabled, .primary:disabled { opacity: 0.55; cursor: not-allowed; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #eff6ff;
      color: #0a84ff;
      font-size: 12px;
      margin-left: auto;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #f2f4f8;
      color: var(--text);
      border: 1px solid var(--border);
      font-size: 13px;
      min-height: 36px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #a3a3a3;
      box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.12);
      transition: all 0.2s ease;
    }

    details summary {
      cursor: pointer;
      color: var(--brand-strong);
      font-weight: 600;
      margin-top: 6px;
    }

    pre {
      background: #f6f8fb;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid var(--border);
      font-family: "SFMono-Regular", "Consolas", "Menlo", monospace;
      font-size: 12px;
      line-height: 1.5;
      color: #1f2937;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 8px 10px;
      vertical-align: top;
    }

    th {
      background: #f8fafc;
      color: #374151;
      font-weight: 700;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:last-child td { border-bottom: none; }

    textarea.field-question, textarea.field-ga-answer,
    textarea.field-source-locator, textarea.field-source-excerpt,
    textarea.field-comment {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    .small-input { width: 90px; }

    #progress-container {
      display: none;
      margin-top: 12px;
      background: #f7f9fd;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    #progress-text {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--brand);
      box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.4);
      animation: pulse 1.6s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.45); }
      70% { box-shadow: 0 0 0 12px rgba(10, 132, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); }
    }

    .progress-bar-bg {
      width: 100%;
      background-color: #e9eef6;
      border-radius: 10px;
      overflow: hidden;
      height: 16px;
      border: 1px solid #d7deea;
    }

    #progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(120deg, #0a84ff, #4bc7ff, #34c759);
      background-size: 200% 200%;
      animation: shimmer 2s linear infinite;
      transition: width 0.35s ease;
    }

    @keyframes shimmer {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    #chunk-info {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-dot"></div>
      <div>
        <h1>JSON分片考试题生成器（DeepSeek + GA 对）</h1>
        <p class="subhead">上传 JSON 分片、自动生成 GA 对并可在线编辑导出 DOCX</p>
      </div>
    </header>

    <div class="card">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <h2>① 上传 JSON 分片 &amp; 生成 GA 对</h2>
        <span class="pill">自动识别分片数量</span>
      </div>
      <div class="status-row">
        <div class="status-pill" id="connection-pill">
          <span class="status-dot" id="connection-dot"></span>
          <span id="connection-text">正在检测 DeepSeek 连接…</span>
        </div>
        <button type="button" class="ghost" id="retry-connection">重新检测</button>
      </div>
      <form id="ga-form">
        <div class="form-grid">
          <div>
            <label>上传 JSON 文件</label>
            <input type="file" name="file" id="json-file" required />
            <div class="hint">支持直接 list 或 {"chunks": [...]} 结构</div>
          </div>
          <div>
            <label>题目总数量（GA 对数）</label>
            <input type="number" name="num_questions" id="num-questions" value="20" min="1" />
          </div>
          <div>
            <label>分片索引（留空自动全选）</label>
            <input type="text" name="chunk_indices" id="chunk-indices" placeholder="例如：0,1,2 或留空使用全部" />
            <div id="chunk-info">等待文件解析…</div>
          </div>
          <div>
            <label>Docx 标题</label>
            <input type="text" id="docx-title" value="培训考试题（含答案与原文引用）" />
          </div>
          <div class="full-row">
            <label>System Prompt（可编辑）</label>
            <textarea name="system_prompt" id="system-prompt" placeholder="留空则使用后端默认 GA 提示词"></textarea>
            <details>
              <summary>查看默认 GA 提示词大致结构（仅参考）</summary>
              <pre>
- 角色：铁路通信/信号/防雷规范命题专家
- 目标：基于规范片段生成 GA 对（问题 + 标准答案）
- 要求：
  * 问题围绕定义、数值、范围、原则、做法等
  * 答案准确、简洁，可直接作为标准答案
  * 每道题带原文摘录、来源定位
  * 输出为 {"ga_pairs": [...]} 的 JSON，包含 question_type、options、ga_answer 等字段
- 题型：包含单选题、多选题、判断题和简答题；选择题需给出 A~D(或至多 A~F) 选项
              </pre>
            </details>
          </div>
        </div>
        <div class="button-row">
          <button class="primary" type="submit">开始生成 GA 对</button>
        </div>

        <div id="progress-container">
          <div id="progress-text"><span class="pulse-dot"></span><span>正在连接 DeepSeek 服务…</span></div>
          <div class="progress-bar-bg">
            <div id="progress-bar"></div>
          </div>
        </div>

        <div id="error-banner" class="error-banner"></div>
      </form>
    </div>

    <div class="card">
      <h2>② GA 对在线编辑</h2>
      <p class="subhead">生成完成后会出现在下表，可直接修改题目、答案、难度、来源定位与原文摘录。</p>

      <table id="ga-table" style="display:none;">
        <thead>
          <tr>
            <th>#</th>
            <th>ID</th>
            <th>题型（question_type）</th>
            <th>题目（question）</th>
            <th>选项（options，按行分隔）</th>
            <th>答案（ga_answer）</th>
            <th>难度（difficulty）</th>
            <th>来源定位（source_locator）</th>
            <th>原文摘录（source_excerpt）</th>
            <th>命题说明（comment）</th>
          </tr>
        </thead>
        <tbody id="ga-table-body"></tbody>
      </table>

      <div id="no-data-tip" style="margin-top:8px; color:#94a3b8;">尚未生成 GA 对。</div>
    </div>

    <div class="card">
      <h2>③ 导出 DOCX（试题 + 答案 + 原文引用）</h2>
      <div class="button-row">
        <button id="export-docx-btn" class="ghost" disabled>导出为 DOCX</button>
      </div>
    </div>
  </div>

  <script>
    let currentGAPairs = [];
    let progressTimer = null;
    let checkingConnection = false;

    function loadDefaultSystemPrompt() {
      const textarea = document.getElementById('system-prompt');
      if (!textarea) return;

      fetch('/api/system-prompt')
        .then(res => res.json())
        .then(data => {
          if (!data || !data.system_prompt) return;
          if (!textarea.value.trim()) {
            textarea.value = data.system_prompt;
          }
        })
        .catch(err => {
          console.error('加载默认 System Prompt 失败：', err);
        });
    }

    function renderTable() {
      const table = document.getElementById('ga-table');
      const tbody = document.getElementById('ga-table-body');
      const tip = document.getElementById('no-data-tip');
      const exportBtn = document.getElementById('export-docx-btn');

      tbody.innerHTML = '';

      if (!currentGAPairs || currentGAPairs.length === 0) {
        table.style.display = 'none';
        tip.style.display = 'block';
        exportBtn.disabled = true;
        return;
      }

      currentGAPairs.forEach((p, idx) => {
        const tr = document.createElement('tr');

        const tdIndex = document.createElement('td');
        tdIndex.textContent = idx + 1;
        tr.appendChild(tdIndex);

        const tdId = document.createElement('td');
        const inputId = document.createElement('input');
        inputId.type = 'text';
        inputId.className = 'field-id small-input';
        inputId.value = p.id || ('q' + (idx + 1));
        tdId.appendChild(inputId);
        tr.appendChild(tdId);

        const tdType = document.createElement('td');
        const inputType = document.createElement('input');
        inputType.type = 'text';
        inputType.className = 'field-question-type small-input';
        inputType.placeholder = 'single_choice / multiple_choice / true_false / short_answer';
        inputType.value = p.question_type || '';
        tdType.appendChild(inputType);
        tr.appendChild(tdType);

        const tdQ = document.createElement('td');
        const taQ = document.createElement('textarea');
        taQ.className = 'field-question';
        taQ.value = p.question || '';
        tdQ.appendChild(taQ);
        tr.appendChild(tdQ);

        const tdOptions = document.createElement('td');
        const taOptions = document.createElement('textarea');
        taOptions.className = 'field-options';
        taOptions.placeholder = '仅选择题填写，一行一个选项，如 A. xxx';
        taOptions.value = Array.isArray(p.options) ? p.options.join('\n') : (p.options || '');
        tdOptions.appendChild(taOptions);
        tr.appendChild(tdOptions);

        const tdA = document.createElement('td');
        const taA = document.createElement('textarea');
        taA.className = 'field-ga-answer';
        taA.value = p.ga_answer || '';
        tdA.appendChild(taA);
        tr.appendChild(tdA);

        const tdDiff = document.createElement('td');
        const inputDiff = document.createElement('input');
        inputDiff.type = 'text';
        inputDiff.className = 'field-difficulty small-input';
        inputDiff.value = p.difficulty || '';
        tdDiff.appendChild(inputDiff);
        tr.appendChild(tdDiff);

        const tdLoc = document.createElement('td');
        const taLoc = document.createElement('textarea');
        taLoc.className = 'field-source-locator';
        taLoc.value = p.source_locator || '';
        tdLoc.appendChild(taLoc);
        tr.appendChild(tdLoc);

        const tdExcerpt = document.createElement('td');
        const taExcerpt = document.createElement('textarea');
        taExcerpt.className = 'field-source-excerpt';
        taExcerpt.value = p.source_excerpt || '';
        tdExcerpt.appendChild(taExcerpt);
        tr.appendChild(tdExcerpt);

        const tdComment = document.createElement('td');
        const taComment = document.createElement('textarea');
        taComment.className = 'field-comment';
        taComment.value = p.comment || '';
        tdComment.appendChild(taComment);
        tr.appendChild(tdComment);

        tbody.appendChild(tr);
      });

      table.style.display = 'table';
      tip.style.display = 'none';
      exportBtn.disabled = false;
    }

    function collectGAPairsFromTable() {
      const rows = document.querySelectorAll('#ga-table-body tr');
      const result = [];
      rows.forEach((tr, idx) => {
        const id = tr.querySelector('.field-id').value || ('q' + (idx + 1));
        const question_type = tr.querySelector('.field-question-type').value;
        const question = tr.querySelector('.field-question').value;
        const optionsRaw = tr.querySelector('.field-options').value || '';
        const options = optionsRaw
          .split('\n')
          .map(opt => opt.trim())
          .filter(Boolean);
        const ga_answer = tr.querySelector('.field-ga-answer').value;
        const difficulty = tr.querySelector('.field-difficulty').value;
        const source_locator = tr.querySelector('.field-source-locator').value;
        const source_excerpt = tr.querySelector('.field-source-excerpt').value;
        const comment = tr.querySelector('.field-comment').value;

        result.push({
          id,
          question_type,
          question,
          options,
          ga_answer,
          difficulty,
          source_locator,
          source_excerpt,
          comment
        });
      });
      return result;
    }

    function startProgress() {
      const container = document.getElementById('progress-container');
      const text = document.getElementById('progress-text');
      const bar = document.getElementById('progress-bar');
      showErrors([]);
      container.style.display = 'block';
      text.innerHTML = '<span class="pulse-dot"></span><span>正在连接 DeepSeek 服务…</span>';
      bar.style.width = '14%';
      let percent = 14;
      if (progressTimer) clearInterval(progressTimer);
      progressTimer = setInterval(() => {
        percent = Math.min(percent + Math.random() * 10, 90);
        bar.style.width = `${percent}%`;
      }, 450);
    }

    function finishProgress(success = true) {
      const container = document.getElementById('progress-container');
      const text = document.getElementById('progress-text');
      const bar = document.getElementById('progress-bar');
      if (progressTimer) clearInterval(progressTimer);
      bar.style.width = '100%';
      text.innerHTML = success
        ? '<span class="pulse-dot" style="background: var(--accent);"></span><span>生成完成</span>'
        : '<span class="pulse-dot" style="background: #ff3b30;"></span><span>生成失败，请检查后端日志</span>';
      setTimeout(() => { container.style.display = 'none'; }, 800);
    }

    function showErrors(errors = []) {
      const banner = document.getElementById('error-banner');
      if (errors.length === 0) {
        banner.style.display = 'none';
        banner.innerHTML = '';
        return;
      }
      banner.style.display = 'block';
      banner.innerHTML = errors.map(e => `<div class="error-line">⚠️ ${e}</div>`).join('');
    }

    function setConnectionState({ status, message }) {
      const pill = document.getElementById('connection-pill');
      const dot = document.getElementById('connection-dot');
      const text = document.getElementById('connection-text');

      text.textContent = message;

      if (status === 'ok') {
        pill.style.background = '#edfff5';
        pill.style.borderColor = '#b7f2d0';
        dot.style.background = 'var(--accent)';
        dot.style.boxShadow = '0 0 0 6px rgba(52, 199, 89, 0.22)';
      } else if (status === 'checking') {
        pill.style.background = '#f2f4f8';
        pill.style.borderColor = '#e5e7eb';
        dot.style.background = '#0a84ff';
        dot.style.boxShadow = '0 0 0 6px rgba(10, 132, 255, 0.18)';
      } else {
        pill.style.background = '#fff2f2';
        pill.style.borderColor = '#ffcccc';
        dot.style.background = '#ff3b30';
        dot.style.boxShadow = '0 0 0 6px rgba(255, 59, 48, 0.18)';
      }
    }

    function checkConnection(showToastOnError = false) {
      if (checkingConnection) return;
      checkingConnection = true;
      setConnectionState({ status: 'checking', message: '正在检测 DeepSeek 连接…' });

      fetch('/api/deepseek-health')
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            const extra = data.models?.length ? `（可用模型示例：${data.models.join(', ')}）` : '';
            setConnectionState({ status: 'ok', message: `${data.message}${extra}` });
          } else {
            setConnectionState({ status: 'error', message: data.message || '连接失败，请检查 API Key 或 Base URL。' });
            if (showToastOnError) alert(data.message || '连接 DeepSeek 失败');
          }
        })
        .catch(err => {
          console.error(err);
          setConnectionState({ status: 'error', message: '无法连接后端，请检查服务是否启动。' });
          if (showToastOnError) alert('无法连接后端，请检查服务是否启动。');
        })
        .finally(() => { checkingConnection = false; });
    }

    function parseChunksLength(jsonData) {
      if (Array.isArray(jsonData)) return jsonData.length;
      if (jsonData && Array.isArray(jsonData.chunks)) return jsonData.chunks.length;
      return 0;
    }

    document.getElementById('json-file').addEventListener('change', (e) => {
      const info = document.getElementById('chunk-info');
      const input = document.getElementById('chunk-indices');
      const file = e.target.files?.[0];
      if (!file) {
        info.textContent = '等待文件解析…';
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const parsed = JSON.parse(evt.target.result);
          const length = parseChunksLength(parsed);
          if (length > 0) {
            const indices = Array.from({ length }, (_, i) => i).join(',');
            input.value = indices;
            info.textContent = `检测到 ${length} 个分片，已自动填入索引。`;
          } else {
            info.textContent = '未识别到 chunks 数组，请确认文件格式。';
            input.placeholder = '例如：0,1,2';
          }
        } catch (err) {
          console.error(err);
          info.textContent = '文件不是有效的 JSON，请重新选择。';
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    document.getElementById('retry-connection').addEventListener('click', () => {
      checkConnection(true);
    });

    // 页面加载后立即检测一次连接
    checkConnection();
    loadDefaultSystemPrompt();

    document.getElementById('ga-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const fileInput = document.getElementById('json-file');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('请先选择 JSON 文件。');
        return;
      }

        startProgress();

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('chunk_indices', document.getElementById('chunk-indices').value);
        formData.append('num_questions', document.getElementById('num-questions').value);
        formData.append('system_prompt', document.getElementById('system-prompt').value);

        fetch('/api/generate-ga-from-file', {
          method: 'POST',
          body: formData
        })
          .then(res => res.json())
          .then(data => {
            const errors = data.errors || [];
            finishProgress(errors.length === 0);
            currentGAPairs = data.ga_pairs || [];
            renderTable();
            showErrors(errors);
          })
          .catch(err => {
            console.error(err);
            finishProgress(false);
            showErrors(['网络异常或后端不可用，请稍后重试。']);
            alert('生成 GA 对失败，请检查后端日志。');
          });
      });

    document.getElementById('export-docx-btn').addEventListener('click', function () {
      const gaPairs = collectGAPairsFromTable();
      if (!gaPairs.length) {
        alert('没有 GA 对可导出。');
        return;
      }
      const title = document.getElementById('docx-title').value || '培训考试题（含答案与原文引用）';

      fetch('/export-docx', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title,
          ga_pairs: gaPairs
        })
      })
        .then(res => res.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'exam_ga_pairs.docx';
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        })
        .catch(err => {
          console.error(err);
          alert('导出 DOCX 失败，请检查后端日志。');
        });
    });
  </script>
</body>
</html>
